<!DOCTYPE html>
<html lang="en">
<head>
    <title>DevExtreme jQuery Example</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="dx.fluent.blue.light.css">

    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dx.all.debug.js" charset="utf-8"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body class="dx-surface">
    <div role="main">
        <h1 style="position: fixed; left: 0; top: 0; clip: rect(1px, 1px, 1px, 1px);">Test header</h1>

        <div id="chat"></div>

        <script>
            const id = String(Math.random())
            const user = {
                id,
                name: `Pasha ${id.substring(0, 4)}`,
            }
            const items = [
                {
                    timestamp: new Date(2021, 9, 17, 14, 15),
                    author: {
                        id: 1,
                        name: 'James Paul',
                    },
                    text: 'app.use(express.static(path.join(__dirname, \'./public\')));',
                },
            ];

            const typingStatuses = {}

            const addOrUpdateStatus = (e) => {
                typingStatuses[e.user.id] = e
            }

            const removeStatus = (e) => {
                e?.user?.id && delete typingStatuses[e.user.id]
            }

            $(() => {
                const socket = io();

                const instance = $("#chat").dxChat({
                    height: 500,
                    items,
                    user,
                    onMessageSend: (e) => {
                        e.component.renderMessage(e.message)

                        socket.emit('message', e.message)
                    },
                    onTypingStart: ({ user }) => {
                        socket.emit('typingstart', { user })
                    },
                    onTypingEnd: ({ user }) => {
                        socket.emit('typingend', { user })
                    },
                }).dxChat('instance')

                /**
                 * Sockets
                 */
                socket.on('message', function(message) {
                    instance.renderMessage(message)
                })
                socket.on('typingstart', function(status) {
                    addOrUpdateStatus(status)

                    instance.option({ typingStatuses })
                })
                socket.on('typingend', function(status, id) {
                    removeStatus(status)

                    instance.option({ typingStatuses })
                })
            });
        </script>
    </div>
</body>
</html>
